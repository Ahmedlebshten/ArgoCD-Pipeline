pipeline {
    agent any

    environment {
        AWS_REGION = 'us-east-1'
        CLUSTER_NAME = 'hello-devops-production-cluster'
        MONITORING_NAMESPACE = 'monitoring'
        ARGOCD_NAMESPACE = 'argocd'
        GITHUB_REPO = 'https://github.com/Ahmedlebshten/ArgoCD-Pipeline.git'
    }

    stages {

        stage('Update Kubeconfig') {
            steps {
                sh '''
                  set -e
                  echo "ðŸ”¹ Updating kubeconfig..."
                  aws eks update-kubeconfig --region $AWS_REGION --name $CLUSTER_NAME
                '''
            }
        }

        stage('Add Helm Repositories') {
            steps {
                sh '''
                  set -e
                  echo "ðŸ”¹ Adding Helm repositories..."
                  helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
                  helm repo add grafana https://grafana.github.io/helm-charts
                  helm repo update
                  echo "âœ… Helm repositories added successfully!"
                '''
            }
        }

        stage('Create Monitoring Namespace') {
            steps {
                sh '''
                  set -e
                  echo "ðŸ”¹ Creating monitoring namespace..."
                  kubectl create namespace $MONITORING_NAMESPACE --dry-run=client -o yaml | kubectl apply -f -
                  echo "âœ… Namespace created!"
                '''
            }
        }

        stage('Install Prometheus') {
            steps {
                sh '''
                  set -e
                  echo "ðŸ”¹ Installing Prometheus..."
                  helm upgrade --install prometheus prometheus-community/kube-prometheus-stack \\
                    --namespace $MONITORING_NAMESPACE \\
                    --values monitoring/prometheus-values.yaml \\
                    --wait \\
                    --timeout 10m
                  echo "âœ… Prometheus installed successfully!"
                '''
            }
        }

        stage('Install Loki') {
            steps {
                sh '''
                  set -e
                  echo "ðŸ”¹ Installing Loki..."
                  helm upgrade --install loki grafana/loki-stack \\
                    --namespace $MONITORING_NAMESPACE \\
                    --values monitoring/loki-values.yaml \\
                    --wait \\
                    --timeout 10m
                  echo "âœ… Loki installed successfully!"
                '''
            }
        }

        stage('Install Grafana') {
            steps {
                sh '''
                  set -e
                  echo "ðŸ”¹ Installing Grafana..."
                  helm upgrade --install grafana grafana/grafana \\
                    --namespace $MONITORING_NAMESPACE \\
                    --values monitoring/grafana-values.yaml \\
                    --wait \\
                    --timeout 10m
                  echo "âœ… Grafana installed successfully!"
                '''
            }
        }

        stage('Create Monitoring ArgoCD Application') {
            steps {
                sh '''
                  set -e

                  echo "ðŸ”¹ Creating ArgoCD Monitoring Application..."

                  kubectl apply -f - <<EOF
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: monitoring
  namespace: $ARGOCD_NAMESPACE
spec:
  project: default
  source:
    repoURL: $GITHUB_REPO
    targetRevision: HEAD
    path: monitoring
  destination:
    server: https://kubernetes.default.svc
    namespace: $MONITORING_NAMESPACE
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
EOF

                  echo "ðŸŽ‰ Monitoring Application Created Successfully!"
                '''
            }
        }

        stage('Verify Deployment') {
            steps {
                sh '''
                  set -e
                  echo "ðŸ”¹ Verifying deployments..."
                  
                  echo "ðŸ“Š Checking Pods Status:"
                  kubectl get pods -n $MONITORING_NAMESPACE
                  
                  echo "ðŸ“Š Checking Services:"
                  kubectl get svc -n $MONITORING_NAMESPACE
                  
                  echo "ðŸ“Š ArgoCD Application Status:"
                  kubectl get application monitoring -n $ARGOCD_NAMESPACE
                  
                  echo "ðŸŽ‰ All monitoring components deployed successfully!"
                '''
            }
        }

        stage('Get Access Information') {
            steps {
                sh '''
                  set -e
                  echo "======================================"
                  echo "ðŸŽ¯ GRAFANA ACCESS INFORMATION"
                  echo "======================================"
                  echo "ðŸ“Œ Getting Grafana LoadBalancer URL..."
                  kubectl get svc grafana -n $MONITORING_NAMESPACE
                  echo ""
                  echo "ðŸ‘¤ Username: admin"
                  echo "ðŸ”‘ Password: admin123"
                  echo "======================================"
                '''
            }
        }
    }

    post {
        success {
            echo "======================================"
            echo "ðŸŽ‰ Pipeline Completed Successfully!"
            echo "======================================"
            echo "âœ… Prometheus installed and running"
            echo "âœ… Loki installed and running"
            echo "âœ… Grafana installed and running"
            echo "âœ… ArgoCD Application created"
            echo "======================================"
        }
        failure {
            echo "âŒ Pipeline failed. Check logs above for details."
        }
    }
}
